import dotenv from 'dotenv';
dotenv.config();

import { Request, Response } from 'express';
import { createClient } from '@supabase/supabase-js';

// Configuraci√≥n de Supabase
const supabaseUrl = process.env.SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_ANON_KEY;

// Crear cliente Supabase
let supabase: any = null;

if (supabaseUrl && supabaseKey) {
  supabase = createClient(supabaseUrl, supabaseKey);
  console.log('‚úÖ Cliente Supabase inicializado correctamente');
} else {
  console.error('‚ùå Variables de Supabase no configuradas');
}

// M√âTODO: createOrder CON PRECIO CORRECTO
export const createOrder = async (req: Request, res: Response) => {
  try {
    console.log('üìù ==============================');
    console.log('üìù INICIANDO CREACI√ìN DE PEDIDO');
    console.log('üìù ==============================');

    console.log('üìã Datos recibidos del frontend:');
    console.log(JSON.stringify(req.body, null, 2));

    const {
      customerName,
      packageInfo,
      flavorIds,
      sweetness,
      crushedType,
      paymentProofUrl
    } = req.body;

    console.log('üîç Validando campos requeridos...');
    console.log('  - customerName:', customerName ? '‚úÖ' : '‚ùå', customerName);
    console.log('  - packageInfo:', packageInfo ? '‚úÖ' : '‚ùå', packageInfo);
    console.log('  - flavorIds:', flavorIds ? '‚úÖ' : '‚ùå', flavorIds);
    console.log('  - sweetness:', sweetness ? '‚úÖ' : '‚ùå', sweetness);
    console.log('  - crushedType:', crushedType ? '‚úÖ' : '‚ùå', crushedType);
    console.log('  - paymentProofUrl:', paymentProofUrl ? '‚úÖ' : '‚ùå', paymentProofUrl);

    // Validar datos requeridos
    if (!customerName || !packageInfo || !flavorIds || !sweetness || !crushedType || !paymentProofUrl) {
      console.log('‚ùå Faltan campos requeridos');
      return res.status(400).json({
        success: false,
        error: 'Faltan campos requeridos',
        missing: {
          customerName: !customerName,
          packageInfo: !packageInfo,
          flavorIds: !flavorIds,
          sweetness: !sweetness,
          crushedType: !crushedType,
          paymentProofUrl: !paymentProofUrl
        }
      });
    }

    // ‚ú® NUEVO: Extraer el precio del packageInfo
    let extractedPrice = 1; // valor por defecto

    try {
      console.log('üí∞ Extrayendo precio del packageInfo:', packageInfo);

      // Buscar el patr√≥n "- XX Bs -" en el packageInfo
      // Ejemplo: "Paquete Black - 30 Bs - 150 g"
      const priceMatch = packageInfo.match(/- (\d+(?:\.\d+)?) Bs -/);

      if (priceMatch && priceMatch[1]) {
        extractedPrice = parseFloat(priceMatch[1]);
        console.log('üí∞ ‚úÖ Precio extra√≠do exitosamente:', extractedPrice, 'Bs');
      } else {
        console.log('‚ö†Ô∏è No se pudo extraer el precio con el patr√≥n esperado');
        console.log('‚ö†Ô∏è Usando valor por defecto:', extractedPrice, 'Bs');

        // Intentar patr√≥n alternativo sin guiones
        const altPriceMatch = packageInfo.match(/(\d+(?:\.\d+)?) Bs/);
        if (altPriceMatch && altPriceMatch[1]) {
          extractedPrice = parseFloat(altPriceMatch[1]);
          console.log('üí∞ ‚úÖ Precio extra√≠do con patr√≥n alternativo:', extractedPrice, 'Bs');
        }
      }
    } catch (error) {
      console.log('‚ö†Ô∏è Error extrayendo precio:', error);
      console.log('‚ö†Ô∏è Usando valor por defecto:', extractedPrice, 'Bs');
    }

    // Preparar datos para la base de datos
    const orderData = {
      flavors: flavorIds,
      sweetness: sweetness,  // ‚Üê AGREGAR ESTA L√çNEA
      crushed_type: crushedType,
      package_type: packageInfo,
      amount: extractedPrice,
      notes: null,  // ‚Üê CAMBIAR: quitar la dulzura
      status: 'pending',
      full_name: customerName,
      payment_proof_url: paymentProofUrl,
      created_at: new Date().toISOString()
    };

    console.log('üíæ Datos preparados para guardar:');
    console.log(JSON.stringify(orderData, null, 2));
    console.log('üí∞ Amount final que se guardar√°:', extractedPrice, 'Bs');

    // Verificar si Supabase est√° disponible
    if (!supabase) {
      console.warn('‚ö†Ô∏è Supabase no disponible, no se puede guardar el pedido');
      return res.status(500).json({
        success: false,
        error: 'Configuraci√≥n de base de datos incompleta',
        message: 'Variables de entorno de Supabase no configuradas correctamente'
      });
    }

    console.log('üîó Conectando a Supabase...');

    // Test de conexi√≥n y estructura de tabla
    try {
      console.log('üîç Verificando tabla "orders"...');

      // Primero hacer un SELECT simple para verificar la conexi√≥n
      const { data: testData, error: testError } = await supabase
        .from('orders')
        .select('*')
        .limit(1);

      if (testError) {
        console.error('‚ùå Error de conexi√≥n/tabla:', testError);
        return res.status(500).json({
          success: false,
          error: 'Error de base de datos - tabla no accesible',
          message: testError.message,
          supabaseError: testError
        });
      }

      console.log('‚úÖ Conexi√≥n a tabla "orders" exitosa');

    } catch (error) {
      console.error('‚ùå Error de conexi√≥n general:', error);
      return res.status(500).json({
        success: false,
        error: 'Error de conexi√≥n con base de datos',
        message: error instanceof Error ? error.message : 'Error desconocido'
      });
    }

    console.log('üìù Insertando pedido en Supabase...');

    // Insertar en la base de datos
    const { data, error } = await supabase
      .from('orders')
      .insert(orderData)
      .select()
      .single();

    if (error) {
      console.error('‚ùå Error de Supabase INSERT:', error);
      console.error('‚ùå C√≥digo de error:', error.code);
      console.error('‚ùå Detalles:', error.details);
      console.error('‚ùå Hint:', error.hint);
      console.error('‚ùå Message:', error.message);

      return res.status(500).json({
        success: false,
        error: 'Error al insertar en base de datos',
        message: error.message,
        supabaseError: {
          code: error.code,
          details: error.details,
          hint: error.hint
        }
      });
    }

    console.log('‚úÖ Pedido insertado exitosamente:');
    console.log(JSON.stringify(data, null, 2));
    console.log('üí∞ Precio final guardado:', data.amount, 'Bs');

    console.log('‚úÖ ==============================');
    console.log('‚úÖ PEDIDO CREADO EXITOSAMENTE');
    console.log('‚úÖ ==============================');

    res.json({
      success: true,
      data,
      message: 'Pedido creado exitosamente'
    });

  } catch (error) {
    console.error('‚ùå ERROR GENERAL EN CREATE ORDER:', error);
    console.error('‚ùå Stack trace:', error instanceof Error ? error.stack : 'No stack');

    res.status(500).json({
      success: false,
      error: 'Error al crear pedido',
      message: error instanceof Error ? error.message : 'Error desconocido',
      timestamp: new Date().toISOString()
    });
  }
};

// Otras funciones del controlador
export const getOrders = async (req: Request, res: Response) => {
  try {
    if (!supabase) {
      return res.status(500).json({
        success: false,
        error: 'Configuraci√≥n de base de datos incompleta'
      });
    }

    const { data, error } = await supabase
      .from('orders')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      console.error('Error al obtener √≥rdenes:', error);
      return res.status(500).json({
        success: false,
        error: 'Error al obtener √≥rdenes',
        message: error.message
      });
    }

    res.json({
      success: true,
      data,
      message: '√ìrdenes obtenidas exitosamente'
    });

  } catch (error) {
    console.error('Error en getOrders:', error);
    res.status(500).json({
      success: false,
      error: 'Error interno del servidor'
    });
  }
};

// Funci√≥n para obtener paquetes - DESDE SUPABASE
export const getPackages = async (req: Request, res: Response) => {
  try {
    console.log('üì¶ Solicitando paquetes desde Supabase...');

    if (!supabase) {
      return res.status(500).json({
        success: false,
        error: 'Configuraci√≥n de base de datos incompleta'
      });
    }

    const { data, error } = await supabase
      .from('packages')
      .select('*')
      .order('created_at', { ascending: true });

    if (error) {
      console.error('Error al obtener paquetes:', error);
      return res.status(500).json({
        success: false,
        error: 'Error al obtener paquetes',
        message: error.message
      });
    }

    res.json({
      success: true,
      data: data
    });
  } catch (error) {
    console.error('Error en getPackages:', error);
    res.status(500).json({
      success: false,
      error: 'Error interno del servidor'
    });
  }
};

// Funci√≥n para obtener categor√≠as - DESDE SUPABASE
export const getCategories = async (req: Request, res: Response) => {
  try {
    console.log('üìÇ Solicitando categor√≠as desde Supabase...');

    if (!supabase) {
      return res.status(500).json({
        success: false,
        error: 'Configuraci√≥n de base de datos incompleta'
      });
    }

    const { data, error } = await supabase
      .from('categories')
      .select('*')
      .order('created_at', { ascending: true });

    if (error) {
      console.error('Error al obtener categor√≠as:', error);
      return res.status(500).json({
        success: false,
        error: 'Error al obtener categor√≠as',
        message: error.message
      });
    }

    res.json({
      success: true,
      data: data
    });
  } catch (error) {
    console.error('Error en getCategories:', error);
    res.status(500).json({
      success: false,
      error: 'Error interno del servidor'
    });
  }
};

// Funci√≥n para obtener sabores - DESDE SUPABASE
export const getFlavors = async (req: Request, res: Response) => {
  try {
    console.log('üç¨ Solicitando sabores desde Supabase...');
    const { categoryId } = req.params;

    if (!supabase) {
      return res.status(500).json({
        success: false,
        error: 'Configuraci√≥n de base de datos incompleta'
      });
    }

    let query = supabase
      .from('flavors')
      .select('*')
      .order('created_at', { ascending: true });

    // Filtrar por categor√≠a si se proporciona
    if (categoryId) {
      query = query.eq('category_id', categoryId);
    }

    const { data, error } = await query;

    if (error) {
      console.error('Error al obtener sabores:', error);
      return res.status(500).json({
        success: false,
        error: 'Error al obtener sabores',
        message: error.message
      });
    }

    res.json({
      success: true,
      data: data
    });
  } catch (error) {
    console.error('Error en getFlavors:', error);
    res.status(500).json({
      success: false,
      error: 'Error interno del servidor'
    });
  }
};

// Funci√≥n para obtener tipos de machucado - DESDE SUPABASE
export const getCrushedTypes = async (req: Request, res: Response) => {
  try {
    console.log('üî® Solicitando tipos de machucado desde Supabase...');

    if (!supabase) {
      return res.status(500).json({
        success: false,
        error: 'Configuraci√≥n de base de datos incompleta'
      });
    }

    const { data, error } = await supabase
      .from('crushed_types')
      .select('*')
      .order('created_at', { ascending: true });

    if (error) {
      console.error('Error al obtener tipos de machucado:', error);
      return res.status(500).json({
        success: false,
        error: 'Error al obtener tipos de machucado',
        message: error.message
      });
    }

    res.json({
      success: true,
      data: data
    });
  } catch (error) {
    console.error('Error en getCrushedTypes:', error);
    res.status(500).json({
      success: false,
      error: 'Error interno del servidor'
    });
  }
};

// Funci√≥n para subir comprobante de pago - SUPABASE STORAGE
export const uploadPaymentProof = async (req: Request, res: Response) => {
  try {
    console.log('üì§ Recibiendo comprobante de pago...');
    console.log('Archivo recibido:', req.file);

    if (!req.file) {
      return res.status(400).json({
        success: false,
        error: 'No se recibi√≥ ning√∫n archivo'
      });
    }

    if (!supabase) {
      return res.status(500).json({
        success: false,
        error: 'Configuraci√≥n de Supabase incompleta'
      });
    }

    // Generar nombre √∫nico para el archivo
    const fileExt = req.file.originalname.split('.').pop();
    const fileName = `${Date.now()}-${Math.random().toString(36).substring(2)}.${fileExt}`;

    console.log('üì§ Subiendo archivo a Supabase Storage...');

    // Subir archivo a Supabase Storage
    const { data: uploadData, error: uploadError } = await supabase.storage
      .from('payment-proofs')
      .upload(fileName, req.file.buffer, {
        contentType: req.file.mimetype,
        upsert: false
      });

    if (uploadError) {
      console.error('‚ùå Error subiendo a Supabase Storage:', uploadError);
      return res.status(500).json({
        success: false,
        error: 'Error al subir archivo',
        message: uploadError.message
      });
    }

    // Obtener URL p√∫blica del archivo
    const { data: urlData } = supabase.storage
      .from('payment-proofs')
      .getPublicUrl(fileName);

    console.log('‚úÖ Archivo subido exitosamente a Supabase Storage');
    console.log('üîó URL p√∫blica:', urlData.publicUrl);

    res.json({
      success: true,
      message: 'Comprobante subido exitosamente',
      url: urlData.publicUrl,
      filename: fileName
    });

  } catch (error) {
    console.error('Error en uploadPaymentProof:', error);
    res.status(500).json({
      success: false,
      error: 'Error interno del servidor'
    });
  }
};

// Funci√≥n para obtener ventas diarias
export const getDailySales = async (req: Request, res: Response) => {
  try {
    console.log('üìä Solicitando ventas diarias...');

    if (!supabase) {
      return res.status(500).json({
        success: false,
        error: 'Configuraci√≥n de base de datos incompleta'
      });
    }

    const { data, error } = await supabase
      .from('orders')
      .select('*')
      .gte('created_at', new Date().toISOString().split('T')[0]);

    if (error) {
      console.error('Error al obtener ventas diarias:', error);
      return res.status(500).json({
        success: false,
        error: 'Error al obtener ventas diarias',
        message: error.message
      });
    }

    const totalSales = data.reduce((sum: number, order: any) => sum + (order.amount || 0), 0);

    res.json({
      success: true,
      data: {
        orders: data,
        totalOrders: data.length,
        totalSales: totalSales
      }
    });
  } catch (error) {
    console.error('Error en getDailySales:', error);
    res.status(500).json({
      success: false,
      error: 'Error interno del servidor'
    });
  }
};